<?php	//___________________________________________________________________	/**	 * Gestion d'une erreur de requête base de données.	 *	 * @param resource	$bd		Connecteur sur la bd ouverte	 * @param string	$sql	requête SQL provoquant l'erreur	 */	function fd_bd_erreur($bd, $sql) {		$errNum = mysqli_errno($bd);		$errTxt = mysqli_error($bd);		// Collecte des informations facilitant le debugage		$msg = '<h4>Erreur de requête</h4>'				."<pre><b>Erreur mysql :</b> $errNum"				."<br> $errTxt"				."<br><br><b>Requête :</b><br> $sql"				.'<br><br><b>Pile des appels de fonction</b>';		// Récupération de la pile des appels de fonction		$msg .= '<table border="1" cellspacing="0" cellpadding="2">'				.'<tr><td>Fonction</td><td>Appelée ligne</td>'				.'<td>Fichier</td></tr>';		$appels = debug_backtrace();		for ($i = 0, $iMax = count($appels); $i < $iMax; $i++) {			$msg .= '<tr align="center"><td>'					.$appels[$i]['function'].'</td><td>'					.$appels[$i]['line'].'</td><td>'					.$appels[$i]['file'].'</td></tr>';		}		$msg .= '</table></pre>';		fd_bd_erreurExit($msg);	}		//___________________________________________________________________	/**	 * Arrêt du script si erreur base de données.	 * Affichage d'un message d'erreur si on est en phase de	 * développement, sinon stockage dans un fichier log.	 *	 * @param string	$msg	Message affiché ou stocké.	 */	function fd_bd_erreurExit($msg) {		ob_end_clean();		// Supression de tout ce qui						// a pu être déja généré		echo '<!DOCTYPE html><html><head><meta charset="ISO-8859-1"><title>',				'Erreur base de données</title></head><body>',				$msg,				'</body></html>';		exit();	}		//___________________________________________________________________	/**	 * Fonction retournant une date représentée par un entier aaaammjj	 * convertie en une chaine de caractere type jour nomDuMois Année.	 *	 * @param	int		$date			la date sous forme entière	 * @return	string	$dateConvertie	la date convertie en chaîne de caractère	 */	function fb_amj_clair($date){		$listMois = array('','Janvier ','F&eacute;vrier ','Mars ','Avril ','Mai ','Juin ','Juillet ','Ao&ucirc;t ','Septembre ','Octobre ','Novembre ','D&eacute;cembre ');		$jour = (int)(substr($date,6,2));		$mois = (int)(substr($date,4,2));		$annee = (int)(substr($date,0,4));		return $jour.' '.$listMois[$mois].$annee;	}		//___________________________________________________________________	/**	 * Fonction permettant d'afficher l'entête html du site	 * prend en second parametre facultatif une feuille de style css	 * @param string $title	le titre de la page.	 * @param string $styleSheet le nom sans extension de la feuille de style CSS	 */	function fb_html_debut($title,$styleSheet=""){		echo'<!DOCTYPE HTML>',			'<html>',			'<head>',				'<meta charset="ISO-8859-1">',				'<title>',$title,'</title>';		if ($styleSheet!="") {			echo'<link href="../styles/'.$styleSheet.'.css" rel="stylesheet" >';		}		echo'</head>';		}		//___________________________________________________________________	/**	 * Fonction permettant de se connecter	 * @return	resource	la base de données	 */	function fb_bd_connection(){		return mysqli_connect('localhost','brossard_u','brossard_p','brossard_cuiteur');	}		//___________________________________________________________________	/**	 * Fonction affichant la page de blablas d'un utilisateur	 * @param object_mysqli_query $R Résultat de l'éxecution d'une requête contenant les infos nécessaire à l'affichage des blablas.	 */	function fb_aff_blablas($R){		echo'<ul class="bcMessages">';		while($S = mysqli_fetch_assoc($R)){//blablas chuck			echo '<li>					<img src="../upload/',htmlentities($S['blIDAuteur'],ENT_QUOTES,'ISO-8859-1'),'.jpg" width=50 height=50 alt="',htmlentities($S['usPseudo'],ENT_QUOTES,'ISO-8859-1'),'" class="imgAuteur">',					'<p class="debutFin"><a href="index.html" title="index">',htmlentities($S['usPseudo'],ENT_QUOTES,'ISO-8859-1'),'</a> - ',htmlentities($S['usNom'],ENT_QUOTES,'ISO-8859-1'),'</p>',					'<p>',htmlentities($S['blTexte'],ENT_QUOTES,'ISO-8859-1'),'</p>',					'<p class="debutFin">',fb_amj_clair(htmlentities($S['blDate'],ENT_QUOTES,'ISO-8859-1')),' - ',htmlentities($S['blHeure'],ENT_QUOTES,'ISO-8859-1'),'</p>',				'</li>';		}		echo '</ul>';	}		//___________________________________________________________________	/**	 * Fonction vérifiant l'existance d'un pseudo	 * @param	string	$pseudo		le pseudo à vérifier	 * @return	bool	true si le pseudo existe false sinon	 */	function pseudoAlreadyExist($pseudo){		$bd = fb_bd_connection();		$Req = 'SELECT usID FROM users WHERE usPseudo = "'.$pseudo.'"';		$R = mysqli_query($bd,$Req) OR fd_bd_erreur($bd, $Req);		$S = mysqli_fetch_assoc($R);		mysqli_free_result($R);		mysqli_close($bd);		if(count($S) > 0){			return TRUE;		}		else return FALSE;	}		// ___________________________________________________________________	/**	 * Fonction enregistrant l'utilisateur dans la base de données	 * @param	array	$userData	les données saisies par l'utilisateur	 * @return	int		$usID		l'id du nouvel utilisateur	 */	function registerNewUser($userData){		//récupération d'informations		$pseudo = $userData['txtPseudo'];		$passwd = $userData['txtPass'];		$nom = $userData['txtNom'];		$mail = $userData['txtMail'];				//traitement de la date de naissance		$jour = "".$userData['selNais_j'];		if($userData['selNais_j'] < 10) $jour = "0".$jour;//si $jour < 10 on ajoute un '0' pour respecter le format AAAAMMJJ		$mois = "".$userData['selNais_m'];		if($userData['selNais_m'] < 10) $mois = "0".$mois;//si $mois < 10 on ajoute un '0' pour respecter le format AAAAMMJJ		$annee = "".$userData['selNais_a'];		$dateNaissance = intval($annee.$mois.$jour);//on convertie la chaine en un entier utilisable				//traitement de la date d'inscription		$localTime = localTime(time(),TRUE);		$jour = "".$localTime['tm_mday'];		if($localTime['tm_mday'] < 10) $jour = "0".$jour;//si $jour < 10 on ajoute un '0' pour respecter le format AAAAMMJJ		$mois = "".($localTime['tm_mon']+1);		if($localTime['tm_mon'] < 10) $mois = "0".$mois;//si $mois < 10 on ajoute un '0' pour respecter le format AAAAMMJJ		$annee = "".($localTime['tm_year']+1900);//tm_year = année depuis 1900 ==> on ajoute 1900		$dateInscription = intval($annee.$mois.$jour);//on convertie la chaine en un entier utilisable				//traitement de la BD		$bd = fb_bd_connection();		$Req = 'INSERT INTO users (usPseudo,usPasse,usNom,usMail,usDateNaissance,usDateInscription,usVille,usWeb,usBio,usAvecPhoto)				VALUES ("'.$pseudo.'","'.$passwd.'","'.$nom.'","'.$mail.'",'.$dateNaissance.','.$dateInscription.',"","","",0)';		mysqli_query($bd,$Req) OR fd_bd_erreur($bd, $Req);				//récupération de l'id du nouvel utilisateur		$Req = 'SELECT usID FROM users WHERE usPseudo = "'.$pseudo.'"';		$R = mysqli_query($bd,$Req) OR fd_bd_erreur($bd, $Req);		$S = mysqli_fetch_assoc($R);		mysqli_free_result($R);		mysqli_close($bd);		return $S['usID'];	}?>